<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§å‰åœ‹ä¸­ - å­¸ç”Ÿå‡ºç¼ºå¸­ç®¡ç†ç³»çµ±</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary-color: #4CAF50;
            --bg-color: #f4f7f6;
            --text-color: #333;
            --border-radius: 8px;
        }

        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: var(--text-color);
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        h1, h2, h3 { text-align: center; color: #2c3e50; }

        .form-group { margin-bottom: 20px; }

        label { display: block; margin-bottom: 8px; font-weight: bold; }

        input, select {
            width: 100%; padding: 12px; border: 1px solid #ddd;
            border-radius: 6px; font-size: 16px; box-sizing: border-box;
        }

        button {
            width: 100%; padding: 15px; background-color: var(--primary-color);
            color: white; border: none; border-radius: 6px; font-size: 18px;
            cursor: pointer; transition: background 0.3s;
        }
        button:hover { background-color: #45a049; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* Student Selection Grid */
        #student-selection-area {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 10px;
            padding: 15px;
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
        }

        .student-checkbox {
            display: flex;
            align-items: center;
            padding: 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .student-checkbox:hover { background-color: #e8f5e9; border-color: var(--primary-color); }
        .student-checkbox input { width: auto; margin-right: 8px; }
        .student-checkbox.checked { background-color: #e8f5e9; border-color: var(--primary-color); font-weight: bold; }

        /* Radio Group */
        .radio-group { display: flex; gap: 15px; margin-top: 5px; }
        .radio-group label { font-weight: normal; cursor: pointer; display: flex; align-items: center; }
        .radio-group input { margin-right: 5px; width: auto; }

        /* Admin & Lists */
        .list-container { margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px; }
        .record-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; background: #f9f9f9; border-radius: 4px; margin-bottom: 5px;
            border-left: 4px solid #ddd;
        }
        .record-item.ç—…å‡ { border-left-color: #e74c3c; }
        .record-item.äº‹å‡ { border-left-color: #f39c12; }
        .record-item.å…¶ä»– { border-left-color: #3498db; }
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 12px; color: white; }
        .tag.ç—…å‡ { background-color: #e74c3c; }
        .tag.äº‹å‡ { background-color: #f39c12; }
        .tag.å…¶ä»– { background-color: #3498db; }

        #admin-section { display: none; margin-top: 40px; border-top: 2px dashed #ccc; padding-top: 20px; }
        .admin-login-trigger { text-align: center; margin-top: 50px; font-size: 12px; color: #ccc; }
        .admin-login-trigger a { cursor: pointer; text-decoration: none; color: #ccc; }
        
        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff;
            text-align: center; border-radius: 2px; padding: 16px; position: fixed;
            z-index: 999; left: 50%; bottom: 30px; transform: translateX(-50%);
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <div class="container">
        <h1>å¤§å‰åœ‹ä¸­<br><span style="font-size: 0.8em; color: #666;">å­¸ç”Ÿå‡ºç¼ºå¸­å›å ±</span></h1>
        
        <div id="teacher-form">
            <div class="form-group">
                <label for="date">æ—¥æœŸ</label>
                <input type="date" id="date">
            </div>

            <div class="form-group">
                <label for="class-select">ç­ç´š</label>
                <select id="class-select" onchange="onClassChange()">
                    <option value="" disabled selected>è«‹é¸æ“‡ç­ç´š</option>
                    </select>
            </div>

            <div class="form-group">
                <label>é¸æ“‡è«‹å‡å­¸ç”Ÿ</label>
                <div id="student-loading" style="display:none; color: #666;">è¼‰å…¥å­¸ç”Ÿåå–®ä¸­...</div>
                <div id="student-selection-area">
                    <p style="color: #999; grid-column: 1/-1; text-align: center;">è«‹å…ˆé¸æ“‡ç­ç´š</p>
                </div>
            </div>

            <div class="form-group">
                <label>è«‹å‡é¡åˆ¥</label>
                <div class="radio-group">
                    <label><input type="radio" name="leaveType" value="ç—…å‡" checked> ç—…å‡</label>
                    <label><input type="radio" name="leaveType" value="äº‹å‡"> äº‹å‡</label>
                    <label><input type="radio" name="leaveType" value="å…¶ä»–"> å…¶ä»–</label>
                </div>
            </div>

            <button onclick="submitData()">é€å‡ºè³‡æ–™</button>

            <div class="list-container" id="teacher-list-area" style="display:none;">
                <div class="list-title">ğŸ“‹ <span id="current-class-name"></span> ä»Šæ—¥å·²ç™»éŒ„åå–®ï¼š</div>
                <div id="teacher-records-container"></div>
            </div>
        </div>

        <div id="admin-section">
            <h2>å¾Œå°ç®¡ç†ç³»çµ±</h2>
            <div id="login-panel">
                <div class="form-group">
                    <label>ç®¡ç†å“¡å¯†ç¢¼</label>
                    <input type="password" id="admin-pwd" placeholder="è¼¸å…¥å¯†ç¢¼">
                </div>
                <button onclick="checkLogin()" style="background-color: #607d8b;">ç™»å…¥</button>
            </div>

            <div id="data-panel" style="display: none;">
                <div style="margin-bottom: 15px; text-align: right;">
                    <button onclick="logout()" style="width: auto; padding: 5px 15px; background-color: #999;">ç™»å‡º</button>
                </div>

                <div style="background: #eef2f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin-top:0;">åŒ¯å…¥å­¸ç”Ÿåå–® (CSV)</h3>
                    <p style="font-size: 14px; color: #666;">è«‹é¸å–æ‰€æœ‰ç­ç´šçš„ CSV æª”æ¡ˆ (å¦‚ï¼š114ç­ç´šåæ¢...101.csv)</p>
                    <input type="file" id="csv-files" multiple accept=".csv" style="background: white;">
                    <button onclick="processFiles()" style="margin-top: 10px; background-color: #008CBA;">é–‹å§‹åŒ¯å…¥</button>
                    <div id="import-log" style="margin-top: 10px; font-size: 12px; color: #333; max-height: 100px; overflow-y: auto;"></div>
                </div>

                <div class="form-group">
                    <label>æª¢è¦–è«‹å‡ç´€éŒ„ (ä¾æ—¥æœŸ)</label>
                    <input type="date" id="admin-date-filter">
                </div>
                <div id="records-container"></div>
            </div>
        </div>
    </div>

    <div class="admin-login-trigger"><a onclick="toggleAdminView()">Admin Login</a></div>
    <div id="toast"></div>

    <script>
        // 1. Firebase Init
        const firebaseConfig = {
            apiKey: "AIzaSyAeD-SR6_4uhGB1JH5PChkTPqyyNlNZpFY",
            authDomain: "leave-c84f8.firebaseapp.com",
            projectId: "leave-c84f8",
            storageBucket: "leave-c84f8.firebasestorage.app",
            messagingSenderId: "875704438036",
            appId: "1:875704438036:web:e4ff18be5dd41f80828601",
            measurementId: "G-DJ4538SQP8"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // 2. Class Dropdown Init
        const classSelect = document.getElementById('class-select');
        function initClassDropdown() {
            classSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡ç­ç´š</option>';
            const ranges = { 1: 5, 2: 4, 3: 5 };
            for (let g = 1; g <= 3; g++) {
                for (let c = 1; c <= ranges[g]; c++) {
                    const val = `${g}${c.toString().padStart(2, '0')}`;
                    const opt = document.createElement('option');
                    opt.value = val;
                    opt.textContent = `${g}å¹´${c}ç­`;
                    classSelect.appendChild(opt);
                }
            }
        }
        initClassDropdown();

        // Dates
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date').value = today;
        document.getElementById('admin-date-filter').value = today;

        // 3. Teacher UI: Load Students
        async function onClassChange() {
            const classCode = classSelect.value;
            if (!classCode) return;

            const area = document.getElementById('student-selection-area');
            const loading = document.getElementById('student-loading');
            
            area.innerHTML = '';
            loading.style.display = 'block';

            try {
                // Fetch student list from Firestore 'classes' collection
                const doc = await db.collection('classes').doc(classCode).get();
                loading.style.display = 'none';

                if (doc.exists && doc.data().students && doc.data().students.length > 0) {
                    const students = doc.data().students;
                    // Sort by seat no just in case
                    students.sort((a, b) => a.no - b.no);

                    students.forEach(s => {
                        const label = document.createElement('label');
                        label.className = 'student-checkbox';
                        label.innerHTML = `
                            <input type="checkbox" value="${s.no}" data-name="${s.name}">
                            <span>${s.no.toString().padStart(2,'0')} ${s.name}</span>
                        `;
                        // Toggle visual style
                        label.querySelector('input').addEventListener('change', function() {
                            if(this.checked) label.classList.add('checked');
                            else label.classList.remove('checked');
                        });
                        area.appendChild(label);
                    });
                } else {
                    area.innerHTML = '<p style="color:red; grid-column:1/-1; text-align:center;">æ­¤ç­ç´šå°šç„¡å­¸ç”Ÿåå–®ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡åŒ¯å…¥ã€‚</p>';
                }
            } catch (e) {
                console.error(e);
                loading.style.display = 'none';
                area.innerHTML = '<p style="color:red;">è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚</p>';
            }

            loadClassRecords(); // Load existing records for today
        }

        // 4. Submit Data
        async function submitData() {
            const date = document.getElementById('date').value;
            const classCode = classSelect.value;
            const className = classSelect.options[classSelect.selectedIndex]?.text;
            const type = document.querySelector('input[name="leaveType"]:checked').value;
            
            // Get selected students
            const checkboxes = document.querySelectorAll('#student-selection-area input:checked');
            if (checkboxes.length === 0) {
                alert("è«‹è‡³å°‘é¸æ“‡ä¸€ä½å­¸ç”Ÿ");
                return;
            }

            const btn = document.querySelector('button[onclick="submitData()"]');
            btn.disabled = true;
            btn.textContent = "å„²å­˜ä¸­...";

            const batch = db.batch();
            let count = 0;

            checkboxes.forEach(chk => {
                const seatNo = parseInt(chk.value);
                const name = chk.getAttribute('data-name');
                const docRef = db.collection("attendance").doc();
                batch.set(docRef, {
                    date, classCode: parseInt(classCode), className,
                    seatNo, name, type, // Added Name to record
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                count++;
            });

            try {
                await batch.commit();
                showToast(`æˆåŠŸæ–°å¢ ${count} ä½å­¸ç”Ÿ`);
                // Uncheck all
                checkboxes.forEach(c => {
                    c.checked = false;
                    c.parentElement.classList.remove('checked');
                });
                loadClassRecords();
            } catch (e) {
                alert("å„²å­˜å¤±æ•—");
                console.error(e);
            } finally {
                btn.disabled = false;
                btn.textContent = "é€å‡ºè³‡æ–™";
            }
        }

        // 5. Load Records (Teacher View)
        let teacherUnsub;
        function loadClassRecords() {
            const date = document.getElementById('date').value;
            const classCode = classSelect.value;
            if(!classCode) return;

            if(teacherUnsub) teacherUnsub();
            const container = document.getElementById('teacher-records-container');
            document.getElementById('teacher-list-area').style.display = 'block';
            document.getElementById('current-class-name').textContent = classSelect.options[classSelect.selectedIndex].text;

            teacherUnsub = db.collection("attendance")
                .where("date", "==", date)
                .where("classCode", "==", parseInt(classCode))
                .onSnapshot(snap => {
                    const list = [];
                    snap.forEach(d => list.push(d.data()));
                    list.sort((a,b) => a.seatNo - b.seatNo);
                    
                    container.innerHTML = list.length ? '' : '<p style="color:#999;">ç›®å‰ç„¡è³‡æ–™</p>';
                    list.forEach(d => {
                        const div = document.createElement('div');
                        div.className = `record-item ${d.type}`;
                        // Display Name if available, else just Seat
                        const display = d.name ? `${d.seatNo}è™Ÿ ${d.name}` : `${d.seatNo}è™Ÿ`;
                        div.innerHTML = `<strong>${display}</strong> <span class="tag ${d.type}">${d.type}</span>`;
                        container.appendChild(div);
                    });
                });
        }

        // 6. Admin Logic & Import
        function toggleAdminView() {
            const el = document.getElementById('admin-section');
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
            if(el.style.display === 'block') el.scrollIntoView({behavior:'smooth'});
        }
        function checkLogin() {
            if(document.getElementById('admin-pwd').value === '1234') {
                document.getElementById('login-panel').style.display = 'none';
                document.getElementById('data-panel').style.display = 'block';
                startAdminListener();
            } else alert('å¯†ç¢¼éŒ¯èª¤');
        }
        function logout() {
            document.getElementById('login-panel').style.display = 'block';
            document.getElementById('data-panel').style.display = 'none';
        }

        // CSV Import Function
        async function processFiles() {
            const files = document.getElementById('csv-files').files;
            if(files.length === 0) { alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆ"); return; }

            const log = document.getElementById('import-log');
            log.innerHTML = "é–‹å§‹è™•ç†...<br>";

            for(let i=0; i<files.length; i++) {
                const file = files[i];
                // Try to extract class code from filename (e.g. "... - 101.csv")
                const match = file.name.match(/[-_ ](\d{3})\.csv$/);
                if(!match) {
                    log.innerHTML += `<span style="color:red">è·³é: ${file.name} (ç„¡æ³•è¾¨è­˜ç­ç´šä»£è™Ÿï¼Œæª”åéœ€åŒ…å«å¦‚ ' - 101.csv')</span><br>`;
                    continue;
                }
                const classCode = match[1]; // "101"

                const text = await file.text();
                const students = parseCSV(text);
                
                if(students.length > 0) {
                    // Upload to Firebase
                    await db.collection('classes').doc(classCode).set({
                        students: students,
                        lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    log.innerHTML += `<span style="color:green">æˆåŠŸ: ${classCode}ç­ (å…± ${students.length} äºº)</span><br>`;
                } else {
                    log.innerHTML += `<span style="color:orange">è­¦å‘Š: ${classCode}ç­ è®€å–ä¸åˆ°å­¸ç”Ÿè³‡æ–™</span><br>`;
                }
            }
            log.innerHTML += "<strong>å…¨éƒ¨è™•ç†å®Œæˆï¼</strong>";
        }

        function parseCSV(text) {
            const lines = text.split(/\r\n|\n/);
            const students = [];
            
            // Logic: Scan every line. If a line starts with a number (seat) and has a name next to it.
            // CSV Format based on user file: Repeated columns.
            // We just iterate all columns in a row looking for pair (Number, String).
            
            lines.forEach(line => {
                const parts = line.split(',');
                // Loop through pairs: (0,1), (2,3), (4,5)... 
                // Because the file repeats the list horizontally
                for (let i = 0; i < parts.length - 1; i += 2) { // Step 2 (assuming seat, name, empty, empty...)
                    // Actually snippet shows: 1.0, Name, empty, empty, 1.0, Name...
                    // So we check index i and i+1
                    const seatStr = parts[i].trim();
                    const nameStr = parts[i+1]?.trim();

                    // Check if seatStr is a valid number (e.g., "1.0", "25")
                    // Filter out "114.0" (Year) -> assuming class size < 60
                    const seatNum = parseFloat(seatStr);
                    
                    if (!isNaN(seatNum) && seatNum > 0 && seatNum < 60 && nameStr) {
                        // Check duplicates
                        if (!students.find(s => s.no === seatNum)) {
                            students.push({ no: seatNum, name: nameStr });
                        }
                    }
                }
            });
            return students.sort((a,b) => a.no - b.no);
        }

        // Admin Viewer
        let adminUnsub;
        function startAdminListener() {
            if(adminUnsub) adminUnsub();
            const date = document.getElementById('admin-date-filter').value;
            const container = document.getElementById('records-container');
            
            adminUnsub = db.collection("attendance").where("date", "==", date)
                .onSnapshot(snap => {
                    let list = [];
                    snap.forEach(d => list.push(d.data()));
                    // Sort by Class then Seat
                    list.sort((a,b) => (a.classCode - b.classCode) || (a.seatNo - b.seatNo));
                    
                    container.innerHTML = list.length ? '' : '<p style="text-align:center;color:#999;">æœ¬æ—¥ç„¡è³‡æ–™</p>';
                    let curClass = null;
                    list.forEach(d => {
                        if(d.classCode !== curClass) {
                            container.innerHTML += `<div style="background:#eee;padding:5px;margin:10px 0;font-weight:bold;">${d.className}</div>`;
                            curClass = d.classCode;
                        }
                        container.innerHTML += `
                            <div class="record-item ${d.type}" style="background:white;">
                                <span>${d.seatNo}è™Ÿ ${d.name || ''}</span>
                                <span class="tag ${d.type}">${d.type}</span>
                            </div>`;
                    });
                });
        }
        document.getElementById('admin-date-filter').addEventListener('change', startAdminListener);

        function showToast(msg) {
            const x = document.getElementById("toast");
            x.textContent = msg; x.className = "show";
            setTimeout(()=>x.className=x.className.replace("show",""), 3000);
        }
    </script>
</body>
</html>
