<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§å‰åœ‹ä¸­ - å­¸ç”Ÿå‡ºç¼ºå¸­ç®¡ç†ç³»çµ±</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary-color: #4CAF50;
            --bg-color: #f4f7f6;
            --text-color: #333;
        }

        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: var(--text-color);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        h1, h2, h3 { text-align: center; color: #2c3e50; }

        .form-group { margin-bottom: 20px; }

        label { display: block; margin-bottom: 8px; font-weight: bold; }

        input[type="date"], select, input[type="password"] {
            width: 100%; padding: 12px; border: 1px solid #ddd;
            border-radius: 6px; font-size: 16px; box-sizing: border-box;
        }

        button {
            width: 100%; padding: 15px; background-color: var(--primary-color);
            color: white; border: none; border-radius: 6px; font-size: 18px;
            cursor: pointer; transition: background 0.3s;
        }
        button:hover { background-color: #45a049; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* å­¸ç”Ÿé¸å–®å€å¡Š */
        #student-selection-area {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 10px;
            margin-top: 10px;
            padding: 15px;
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 6px;
            max-height: 400px;
            overflow-y: auto;
        }

        .student-checkbox {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 15px;
        }

        .student-checkbox:hover { background-color: #e8f5e9; border-color: var(--primary-color); }
        .student-checkbox input { transform: scale(1.2); margin-right: 10px; cursor: pointer; }
        .student-checkbox.checked { background-color: #e8f5e9; border-color: var(--primary-color); font-weight: bold; }

        .radio-group { display: flex; gap: 15px; margin-top: 5px; }
        .radio-group label { font-weight: normal; cursor: pointer; display: flex; align-items: center; font-size: 16px;}
        .radio-group input { margin-right: 8px; width: auto; transform: scale(1.2); }

        /* Admin Section */
        #admin-section { display: none; margin-top: 40px; border-top: 2px dashed #ccc; padding-top: 20px; }
        
        .record-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; background: #fff; border-radius: 6px; margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 5px solid #ddd;
        }
        .record-item.ç—…å‡ { border-left-color: #e74c3c; }
        .record-item.äº‹å‡ { border-left-color: #f39c12; }
        .record-item.å…¶ä»– { border-left-color: #3498db; }
        
        .tag { padding: 4px 8px; border-radius: 4px; font-size: 12px; color: white; margin-left: 5px;}
        .tag.ç—…å‡ { background-color: #e74c3c; }
        .tag.äº‹å‡ { background-color: #f39c12; }
        .tag.å…¶ä»– { background-color: #3498db; }

        .admin-login-trigger { text-align: center; margin-top: 50px; font-size: 12px; color: #ccc; }
        .admin-login-trigger a { cursor: pointer; text-decoration: none; color: #ccc; }
        
        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff;
            text-align: center; border-radius: 4px; padding: 16px; position: fixed;
            z-index: 999; left: 50%; bottom: 30px; transform: translateX(-50%);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <div class="container">
        <h1>å¤§å‰åœ‹ä¸­<br><span style="font-size: 0.7em; color: #7f8c8d; font-weight: normal;">å­¸ç”Ÿå‡ºç¼ºå¸­å›å ±ç³»çµ±</span></h1>
        
        <div id="teacher-form">
            <div class="form-group">
                <label for="date">ğŸ“… é¸æ“‡æ—¥æœŸ</label>
                <input type="date" id="date">
            </div>

            <div class="form-group">
                <label for="class-select">ğŸ« é¸æ“‡ç­ç´š</label>
                <select id="class-select" onchange="onClassChange()">
                    <option value="" disabled selected>è«‹é¸æ“‡ç­ç´š</option>
                    </select>
            </div>

            <div class="form-group">
                <label>ğŸ‘¥ é¸æ“‡è«‹å‡å­¸ç”Ÿ (å¯å¤šé¸)</label>
                <div id="student-selection-area">
                    <p style="color: #999; grid-column: 1/-1; text-align: center; padding: 20px;">è«‹å…ˆé¸æ“‡ä¸Šæ–¹ç­ç´š</p>
                </div>
            </div>

            <div class="form-group">
                <label>ğŸ“ è«‹å‡é¡åˆ¥</label>
                <div class="radio-group">
                    <label><input type="radio" name="leaveType" value="ç—…å‡" checked> ç—…å‡</label>
                    <label><input type="radio" name="leaveType" value="äº‹å‡"> äº‹å‡</label>
                    <label><input type="radio" name="leaveType" value="å…¶ä»–"> å…¶ä»–</label>
                </div>
            </div>

            <button onclick="submitData()">é€å‡ºè³‡æ–™</button>

            <div class="form-group" style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                <h3 style="font-size: 1.1em; text-align: left; margin-bottom: 10px;">ğŸ“‹ <span id="current-class-name"></span> ä»Šæ—¥å·²ç™»è¨˜åå–®</h3>
                <div id="teacher-records-container">
                    <p style="color: #999; font-size: 0.9em;">(é¸æ“‡ç­ç´šå¾Œé¡¯ç¤º)</p>
                </div>
            </div>
        </div>

        <div id="admin-section">
            <h2>å¾Œå°ç®¡ç†ç³»çµ±</h2>
            
            <div id="login-panel">
                <div class="form-group">
                    <label>ç®¡ç†å“¡å¯†ç¢¼</label>
                    <input type="password" id="admin-pwd" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
                </div>
                <button onclick="checkLogin()" style="background-color: #607d8b;">ç™»å…¥å¾Œå°</button>
            </div>

            <div id="data-panel" style="display: none;">
                <div style="text-align: right; margin-bottom: 15px;">
                    <button onclick="logout()" style="width: auto; padding: 6px 15px; font-size: 14px; background-color: #95a5a6;">ç™»å‡º</button>
                </div>

                <div class="form-group">
                    <label>ğŸ” æª¢è¦–å…¨æ ¡è«‹å‡ç´€éŒ„</label>
                    <input type="date" id="admin-date-filter">
                </div>
                <div id="records-container"></div>
            </div>
        </div>

    </div>

    <div class="admin-login-trigger"><a onclick="toggleAdminView()">Admin Login</a></div>
    <div id="toast"></div>

    <script>
        // 1. Firebase åˆå§‹åŒ–
        const firebaseConfig = {
            apiKey: "AIzaSyAeD-SR6_4uhGB1JH5PChkTPqyyNlNZpFY",
            authDomain: "leave-c84f8.firebaseapp.com",
            projectId: "leave-c84f8",
            storageBucket: "leave-c84f8.firebasestorage.app",
            messagingSenderId: "875704438036",
            appId: "1:875704438036:web:e4ff18be5dd41f80828601",
            measurementId: "G-DJ4538SQP8"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // 2. å…§å»ºå­¸ç”Ÿè³‡æ–™åº« (è‡ªå‹•éæ¿¾è½‰å‡ºå­¸ç”Ÿ)
        const classData = {"101": [{"no": 1, "name": "æ–¹ç¥¥å®‡"}, {"no": 2, "name": "å³æ˜•ç¥"}, {"no": 3, "name": "æ—ç¥æ°‘"}, {"no": 4, "name": "é™³æ‰¿è²¿"}, {"no": 5, "name": "é™³å† å®"}, {"no": 6, "name": "é»ƒå­ç«¶"}, {"no": 7, "name": "æ¥Šæ°è«º"}, {"no": 8, "name": "è”¡é–”ç¡¯"}, {"no": 9, "name": "è•­å‰å‡±"}, {"no": 10, "name": "è¬æ˜ç¿°"}, {"no": 11, "name": "ç°¡è¾°æ©"}, {"no": 12, "name": "ç¾…å† å¯Œ"}, {"no": 13, "name": "ç‹å¾‹æ¶µ"}, {"no": 14, "name": "ä½•èŠ·æ©"}, {"no": 15, "name": "æä¾‘æ¬£"}, {"no": 16, "name": "ææ—»æ½”"}, {"no": 17, "name": "æèŠ®ç‘€"}, {"no": 18, "name": "æ—ä½‘çˆ"}, {"no": 19, "name": "æ—èŠŠå¦¤"}, {"no": 20, "name": "æ´ªç®æ…ˆ"}, {"no": 21, "name": "è¨±èªç³"}, {"no": 22, "name": "æ¸¸è‹¥è•“"}, {"no": 23, "name": "é»ƒæ€¡ç‘„"}, {"no": 24, "name": "é»ƒèªæŸ”"}, {"no": 25, "name": "å¾æ³³æ¸…"}], "102": [{"no": 1, "name": "ç‹ç·¯é¨°"}, {"no": 2, "name": "å³æ¥¨é€¸"}, {"no": 3, "name": "å³æ¥¨ç¿”"}, {"no": 4, "name": "æåœ‹ç¥¥"}, {"no": 5, "name": "ææ™¨é™½"}, {"no": 6, "name": "æ—æ°¸é †"}, {"no": 7, "name": "æ´ªèŒ‚ç‘‹"}, {"no": 8, "name": "æ´ªæ™¨éˆ"}, {"no": 9, "name": "å¼µæ³³ç´³"}, {"no": 10, "name": "åŠ‰å®¥å‘ˆ"}, {"no": 11, "name": "è•­æ–‡å‚‘"}, {"no": 12, "name": "è³´æ˜±ç¶­"}, {"no": 13, "name": "è³´æ•¬å‹›"}, {"no": 14, "name": "å³å­ç‘œ"}, {"no": 15, "name": "ææ¬£è“‰"}, {"no": 16, "name": "é˜®å¦®è"}, {"no": 17, "name": "æ—ç‘¾è–°"}, {"no": 18, "name": "å¼µèªæ¬"}, {"no": 19, "name": "éƒ­æ•èŠ³"}, {"no": 20, "name": "æ›¾å©·éŒ¡"}, {"no": 21, "name": "é»ƒå®›æ¦†"}, {"no": 22, "name": "é»ƒå©•æ©"}, {"no": 23, "name": "é„­å¤©æ…§"}, {"no": 24, "name": "è•­é›…é¦¨"}, {"no": 25, "name": "é™³å† è±ª"}, {"no": 26, "name": "æ¥Šèˆ’è¬ "}], "103": [{"no": 1, "name": "ç‹ä¿Šé›„"}, {"no": 2, "name": "æå»ºå»·"}, {"no": 3, "name": "æ—ç¥å®‰"}, {"no": 4, "name": "æ—è”šæ¾„"}, {"no": 5, "name": "é‚±å³»å®"}, {"no": 6, "name": "é¦¬è©³é–”"}, {"no": 7, "name": "èŠé‘«è–"}, {"no": 8, "name": "è¨±å‹æº¢"}, {"no": 9, "name": "é™³å‹‡ç”·"}, {"no": 10, "name": "æ›¾æ³“ç¿"}, {"no": 11, "name": "é»ƒç¨æ£‹"}, {"no": 12, "name": "åŠ‰æ‰¿å‹³"}, {"no": 13, "name": "è”¡ç«ºæ©"}, {"no": 14, "name": "ä½•èªå–¬"}, {"no": 15, "name": "å‘‚å®‡ç¦"}, {"no": 16, "name": "æ—éƒé›¯"}, {"no": 17, "name": "å¼µæ²›ç¿"}, {"no": 18, "name": "é»ƒå“ç’‡"}, {"no": 19, "name": "é»ƒæ¹˜æ™´"}, {"no": 20, "name": "æ¥Šä½³ç¿"}, {"no": 21, "name": "åŠ‰æ²…èŠ¯"}, {"no": 22, "name": "è”¡æ˜€è‡»"}, {"no": 23, "name": "è•­ç¿Šæ¶µ"}, {"no": 24, "name": "è¬æƒ å¦‚"}, {"no": 25, "name": "é¡å­è–°"}, {"no": 26, "name": "é‚±è­¯è³¢"}], "104": [{"no": 1, "name": "ç‹è‡´å‡±"}, {"no": 2, "name": "æ±Ÿå³ç’¿"}, {"no": 3, "name": "å³æ–‡å„„"}, {"no": 4, "name": "å³äº¦æ·"}, {"no": 5, "name": "å³ç¿°æ˜‡"}, {"no": 6, "name": "ææ”¿æ©"}, {"no": 7, "name": "é‚±é€¸ä¿®"}, {"no": 8, "name": "æŸ¯ç§‰ä½‘"}, {"no": 9, "name": "éƒ­å®—å¼¦"}, {"no": 10, "name": "é»ƒä»²ä½‘"}, {"no": 11, "name": "é»ƒç…§å‚‘"}, {"no": 12, "name": "é„­èŠ³èŒ‚"}, {"no": 13, "name": "ç‹éŸ»ç”¯"}, {"no": 14, "name": "ä½•å©•æ™¨"}, {"no": 15, "name": "ææ²›ç·¹"}, {"no": 16, "name": "æå®¶ç‘œ"}, {"no": 17, "name": "é˜®è²è¢"}, {"no": 18, "name": "å¼µæ²›æ™´"}, {"no": 19, "name": "å¼µèˆ’å©·"}, {"no": 20, "name": "é™³å®¥è«ª"}, {"no": 21, "name": "é™³æ˜±ç’‡"}, {"no": 22, "name": "é»„é–”å²"}, {"no": 23, "name": "æ›¾æ€¡è–°"}, {"no": 24, "name": "æ¥Šå–¬éˆ"}, {"no": 25, "name": "å¾éœˆç’‡"}], "105": [{"no": 1, "name": "æ—å¤è«º"}, {"no": 2, "name": "å¼µåˆæ™Ÿ"}, {"no": 3, "name": "é™³æ¢“ç¿"}, {"no": 4, "name": "é™³éˆºç¿”"}, {"no": 5, "name": "é»„å­èª "}, {"no": 6, "name": "æ¥Šç«‹å®‰"}, {"no": 7, "name": "é„­ç…œè"}, {"no": 8, "name": "é„­ç…œå¶§"}, {"no": 9, "name": "ç›§ç´³ç¿°"}, {"no": 10, "name": "ç‹äºç²"}, {"no": 11, "name": "ç‹å©•ç‘œ"}, {"no": 12, "name": "æ–½æ¬£ç‘œ"}, {"no": 13, "name": "èŠå­æ¬£"}, {"no": 14, "name": "é™³æ²›æ¶µ"}, {"no": 15, "name": "é™³ä½©çœŸ"}, {"no": 16, "name": "é™³çˆå¦¤"}, {"no": 17, "name": "æ¸¸ç´«æ™´"}, {"no": 18, "name": "æ¥Šæ‡¿çª"}, {"no": 19, "name": "è”¡ä½³è“"}, {"no": 20, "name": "ç°¡æ©å¤š"}, {"no": 21, "name": "è—æ‚»æ¡"}], "201": [{"no": 1, "name": "ç‹é€²å¾·"}, {"no": 2, "name": "æ±Ÿç§‰ç´˜"}, {"no": 3, "name": "ä½•æ›¸æ±"}, {"no": 4, "name": "å³å»ºæ˜±"}, {"no": 5, "name": "æå®‡ç¿”"}, {"no": 6, "name": "ææ±å“²"}, {"no": 7, "name": "æ—æ­£èš"}, {"no": 8, "name": "æ—å®å‹³"}, {"no": 9, "name": "æ—æš„ç¥"}, {"no": 10, "name": "å­«æµ©ç¥¥"}, {"no": 11, "name": "æ¶‚ç¿æ°"}, {"no": 12, "name": "é™³æ¥·å¡"}, {"no": 13, "name": "æ¥Šæ³“é‡"}, {"no": 14, "name": "æ¥Šç§‰éˆ"}, {"no": 15, "name": "é„­åšå‡"}, {"no": 16, "name": "è•­é †é¨°"}, {"no": 17, "name": "ç°¡äºå‡±"}, {"no": 18, "name": "ç¾…æšçµ"}, {"no": 19, "name": "ä½•æµ¿ç¾½"}, {"no": 20, "name": "æ—ç™¸å¦™"}, {"no": 21, "name": "æ—ç¦¹é¦¨"}, {"no": 22, "name": "é‚±æ–¹éƒ"}, {"no": 23, "name": "æŸ¯æ¬£èŠ¸"}, {"no": 24, "name": "éƒ­èŠ¯å¦¤"}, {"no": 25, "name": "é™³å½¥ç«¹"}], "202": [{"no": 2, "name": "ç‹éˆæ¾¤"}, {"no": 4, "name": "æå‡­æ½¤"}, {"no": 5, "name": "ææ‰¿ç¿°"}, {"no": 6, "name": "å¾ç¥¥ç¿"}, {"no": 8, "name": "å¼µç´˜ç¹"}, {"no": 9, "name": "èŠå‡±å‚‘"}, {"no": 10, "name": "è¨±å…æ‡·"}, {"no": 11, "name": "é™³å…‰ç‚³"}, {"no": 12, "name": "é»ƒç§‰è±"}, {"no": 13, "name": "åŠ‰å…‰çˆ"}, {"no": 14, "name": "åŠ‰äº®å‘ˆ"}, {"no": 15, "name": "åŠ‰æ™éŠ˜"}, {"no": 16, "name": "è”¡æ˜€å¡"}, {"no": 17, "name": "è³´æ”¿è£•"}, {"no": 18, "name": "è˜‡è€•ç„"}, {"no": 19, "name": "å³ç«ºå®¹"}, {"no": 20, "name": "æ´ªé‘€å¨£"}, {"no": 21, "name": "æ¶‚ç¾½å²‘"}, {"no": 22, "name": "é™³æ€¡å‡"}, {"no": 23, "name": "é™³ç¾¿ç¶¾"}, {"no": 24, "name": "é™¸å®£ç¾½"}, {"no": 25, "name": "æ¸¸ç·—ç¿"}, {"no": 26, "name": "å¼µæ—¨å›"}, {"no": 27, "name": "ä½™ä¿Šå¸Œ"}], "203": [{"no": 1, "name": "æ±Ÿç§‰ç¿Š"}, {"no": 2, "name": "å³ç§‰æ©™"}, {"no": 3, "name": "ææ³Šç‘¾"}, {"no": 4, "name": "å²³åˆæ‰¿"}, {"no": 5, "name": "æ—å®¸å…‰"}, {"no": 6, "name": "é«˜å˜‰éš†"}, {"no": 7, "name": "å¼µæ±è€€"}, {"no": 8, "name": "å¼µåº­é­"}, {"no": 9, "name": "è¨±å‡±æ˜•"}, {"no": 10, "name": "é™³å½¥å»·"}, {"no": 11, "name": "é™³è‡´èª "}, {"no": 12, "name": "é»ƒè‡´å’Œ"}, {"no": 13, "name": "é»ƒæ¾„å®‡"}, {"no": 14, "name": "åŠ‰æ˜±ç‘‹"}, {"no": 15, "name": "é„­å³»æ±"}, {"no": 16, "name": "è•­ä½³å§”"}, {"no": 17, "name": "ç°¡çš‡æ©"}, {"no": 18, "name": "è˜‡ç¨šå‡±"}, {"no": 19, "name": "æ—æ²›æº±"}, {"no": 20, "name": "å­«æ•é½¡"}, {"no": 22, "name": "é™³å¥•ç¯‰"}, {"no": 23, "name": "ç¾…å¹¸è“"}, {"no": 24, "name": "å§œå­æ¶µ"}], "204": [{"no": 1, "name": "ä½•ç¿ä¿¡"}, {"no": 2, "name": "é™³æŸç¿°"}, {"no": 3, "name": "é»ƒæ˜ç’¿"}, {"no": 4, "name": "é»ƒå‰‡å–„"}, {"no": 5, "name": "é»ƒæšç¿°"}, {"no": 6, "name": "åŠ‰æ ¢ç¿"}, {"no": 7, "name": "æ—èŠŠæƒ "}, {"no": 8, "name": "æ®µå­Ÿæ¶µ"}, {"no": 9, "name": "æ´ªç…œæ™´"}, {"no": 10, "name": "å¼µè‚²æ…ˆ"}, {"no": 11, "name": "è¨±ä»¤éœ"}, {"no": 12, "name": "å»–ä»¥æ™¨"}, {"no": 13, "name": "åŠ‰æ™å¦¤"}], "301": [{"no": 1, "name": "ä½•è‚²é¨°"}, {"no": 2, "name": "ä½•ç§‰ç¥"}, {"no": 3, "name": "æå½¥è«„"}, {"no": 4, "name": "è¨±ç«‹å“²"}, {"no": 5, "name": "é™³å† æ–‡"}, {"no": 6, "name": "æ¹¯å®ˆæ­£"}, {"no": 7, "name": "æ¥Šç™»ç¨‹"}, {"no": 8, "name": "è‘‰å† é™"}, {"no": 9, "name": "åŠ‰éŸ‹è‘£"}, {"no": 10, "name": "ç›§å»ºäº¨"}, {"no": 11, "name": "è˜‡ç…¥å…ƒ"}, {"no": 12, "name": "çŸ³å®¶è“"}, {"no": 13, "name": "å³ç¥å¦¤"}, {"no": 14, "name": "å³å§µè±"}, {"no": 15, "name": "æç‰é³³"}, {"no": 16, "name": "æäºèŠ¸"}, {"no": 17, "name": "æç¾ç§€"}, {"no": 18, "name": "ç›§éœå²‘"}, {"no": 19, "name": "è³´å·§åµ"}, {"no": 20, "name": "ç¾…çªæ·‹"}], "302": [{"no": 1, "name": "æ–¹æŸæ·µ"}, {"no": 3, "name": "æ–½å‡è«º"}, {"no": 4, "name": "å¼µç¥å®‡"}, {"no": 6, "name": "è¨±è© å½¬"}, {"no": 7, "name": "é™³å¨æ„·"}, {"no": 8, "name": "é»ƒå®ç« "}, {"no": 9, "name": "é»ƒç¿”"}, {"no": 10, "name": "åŠ‰ä¸€å®‰"}, {"no": 11, "name": "è³´è¾°æ˜±"}, {"no": 12, "name": "æ–¹å–»æ™´"}, {"no": 13, "name": "ææ€äº­"}, {"no": 14, "name": "æç¾æ©"}, {"no": 15, "name": "é‚±çŸç¶º"}, {"no": 16, "name": "é™³èªæ™¨"}, {"no": 17, "name": "å»–ä»¥æ™´"}, {"no": 18, "name": "åŠ‰é›¨æŸ”"}, {"no": 19, "name": "é¡ç‘œç­ "}, {"no": 20, "name": "é¾”å®¶è±"}, {"no": 21, "name": "è‘‰æ©è“‰"}, {"no": 23, "name": "å‘¨å­ç”„"}], "303": [{"no": 1, "name": "ä½•è‚²é§¿"}, {"no": 2, "name": "ä½•æ¾æ¾¤"}, {"no": 3, "name": "å³æ‰¿å¡"}, {"no": 4, "name": "å³é€²å’Œ"}, {"no": 5, "name": "åŠ‰äºå¶§"}, {"no": 6, "name": "è”¡å®—å¡"}, {"no": 7, "name": "è”¡çç··"}, {"no": 8, "name": "è”¡æŸæ˜±"}, {"no": 9, "name": "é¾å¯Œç¨‹"}, {"no": 10, "name": "é¡å´‡å‡±"}, {"no": 12, "name": "æç‰çª"}, {"no": 13, "name": "æœä»»å©•"}, {"no": 14, "name": "æ—å¦è±«"}, {"no": 15, "name": "é™³éŸ‹æ±"}, {"no": 16, "name": "å»–æ„è²"}, {"no": 17, "name": "è”¡ç‘œå«™"}, {"no": 18, "name": "é„­æ¹˜è“‰"}, {"no": 19, "name": "ç°¡è‹¡å®‰"}, {"no": 21, "name": "æ±Ÿç§‰è»’"}], "304": [{"no": 1, "name": "æ¸¸æ™ºç¿”"}, {"no": 2, "name": "é„­ç§‰æ©"}, {"no": 3, "name": "æå®—è«º"}, {"no": 4, "name": "æ—ç¥ä»»"}, {"no": 5, "name": "ç¿ç¬ ç´˜"}, {"no": 6, "name": "é™³ä¾‘å¨"}, {"no": 7, "name": "é™³å† ç¶¸"}, {"no": 9, "name": "æˆ´è¿å‘ˆ"}, {"no": 10, "name": "è˜‡ç«‹å…ƒ"}, {"no": 11, "name": "è˜‡è–åš"}, {"no": 12, "name": "ä½•ä¸ç‘œ"}, {"no": 13, "name": "å³å¦è±"}, {"no": 14, "name": "å³æ›¼ç”„"}, {"no": 15, "name": "æ—éŸ‹è‡»"}, {"no": 16, "name": "æŸ¯æ·è‹’"}, {"no": 17, "name": "å¼µè»’æ…ˆ"}, {"no": 19, "name": "é™³æ€¡ç‘„"}, {"no": 20, "name": "æ›¾è‹¡ç‘„"}, {"no": 21, "name": "è”¡å§¿å¬ª"}, {"no": 22, "name": "æ¥Šç´«ç’¿"}], "305": [{"no": 1, "name": "å³å­å‹»"}, {"no": 2, "name": "ç¿æ¢“å®¸"}, {"no": 3, "name": "è¨±åšéˆ"}, {"no": 4, "name": "é™³æ–‡æ›¸"}, {"no": 5, "name": "åŠ‰ä¿Šå¾·"}, {"no": 6, "name": "åŠ‰å®¸å‡"}, {"no": 7, "name": "ç¾…ç¥¥ç¿"}, {"no": 8, "name": "ä½•äº®éš"}, {"no": 9, "name": "ä½•ç¦¹æŸ”"}, {"no": 10, "name": "æ—çœŸä¼ƒ"}, {"no": 11, "name": "æ´ªåƒé›…"}, {"no": 13, "name": "æ´ªæ–°æƒ "}, {"no": 14, "name": "å¼µæ›¸ç‘"}, {"no": 15, "name": "é™³è©©æ¶µ"}, {"no": 16, "name": "é»ƒå®‡æ…ˆ"}, {"no": 17, "name": "é»ƒå“è“‰"}, {"no": 18, "name": "é»ƒå®£æ™´"}, {"no": 19, "name": "é»ƒç¿Šé›¯"}, {"no": 20, "name": "æ¥ŠèŠ¸æ¦›"}, {"no": 21, "name": "æ¥Šæ‡¿ç­‘"}, {"no": 22, "name": "è•­å©‰å¦¤"}, {"no": 23, "name": "è¬å£¹å§"}]};

        // 3. åˆå§‹åŒ–æ—¥æœŸèˆ‡é¸å–®
        const classSelect = document.getElementById('class-select');
        const todayStr = new Date().toISOString().split('T')[0];
        document.getElementById('date').value = todayStr;
        document.getElementById('admin-date-filter').value = todayStr;

        // ç”Ÿæˆç­ç´šé¸å–® (ä¾å¹´ç´š)
        function initClassDropdown() {
            classSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡ç­ç´š</option>';
            const ranges = { 1: 5, 2: 4, 3: 5 }; // å„å¹´ç´šç­ç´šæ•¸
            for (let g = 1; g <= 3; g++) {
                for (let c = 1; c <= ranges[g]; c++) {
                    const val = `${g}${c.toString().padStart(2, '0')}`; // e.g., 101, 204
                    const name = `${g}å¹´${c}ç­`;
                    const opt = document.createElement('option');
                    opt.value = val;
                    opt.textContent = name;
                    classSelect.appendChild(opt);
                }
            }
        }
        initClassDropdown();

        // 4. è€å¸«é¸æ“‡ç­ç´š -> è®€å–å…§å»ºåå–®
        function onClassChange() {
            const classCode = classSelect.value;
            if (!classCode) return;

            const area = document.getElementById('student-selection-area');
            area.innerHTML = '';

            // å¾ classData è®€å–
            const students = classData[classCode];

            if (students && students.length > 0) {
                students.forEach(s => {
                    const label = document.createElement('label');
                    label.className = 'student-checkbox';
                    label.innerHTML = `
                        <input type="checkbox" value="${s.no}" data-name="${s.name}">
                        <span><strong>${s.no}</strong> ${s.name}</span>
                    `;
                    // é»é¸è®Šè‰²æ•ˆæœ
                    label.querySelector('input').addEventListener('change', function() {
                        if(this.checked) label.classList.add('checked');
                        else label.classList.remove('checked');
                    });
                    area.appendChild(label);
                });
            } else {
                area.innerHTML = '<p style="color:red; grid-column:1/-1; text-align:center; padding:10px;">æŸ¥ç„¡æ­¤ç­ç´šè³‡æ–™</p>';
            }

            loadClassRecords(); // è¼‰å…¥ä»Šæ—¥è«‹å‡ç‹€æ³
        }

        // 5. é€å‡ºè³‡æ–™ (å¯«å…¥ Firestore)
        async function submitData() {
            const date = document.getElementById('date').value;
            const classCode = classSelect.value;
            const className = classSelect.options[classSelect.selectedIndex]?.text;
            
            if (!date || !classCode) { alert("è«‹é¸æ“‡æ—¥æœŸèˆ‡ç­ç´š"); return; }
            
            const type = document.querySelector('input[name="leaveType"]:checked').value;
            const checkboxes = document.querySelectorAll('#student-selection-area input:checked');
            
            if (checkboxes.length === 0) {
                alert("è«‹è‡³å°‘å‹¾é¸ä¸€ä½å­¸ç”Ÿ");
                return;
            }

            const btn = document.querySelector('button[onclick="submitData()"]');
            btn.disabled = true;
            btn.textContent = "è³‡æ–™å„²å­˜ä¸­...";

            const batch = db.batch();
            let count = 0;

            checkboxes.forEach(chk => {
                const seatNo = parseInt(chk.value);
                const name = chk.getAttribute('data-name');
                const docRef = db.collection("attendance").doc(); 
                
                batch.set(docRef, {
                    date: date,
                    classCode: parseInt(classCode),
                    className: className,
                    seatNo: seatNo,
                    name: name,
                    type: type,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                count++;
            });

            try {
                await batch.commit();
                showToast(`æˆåŠŸç™»è¨˜ ${count} ä½å­¸ç”Ÿï¼`);
                // æ¸…é™¤å‹¾é¸ç‹€æ…‹
                checkboxes.forEach(c => {
                    c.checked = false;
                    c.parentElement.classList.remove('checked');
                });
                loadClassRecords(); 
            } catch (e) {
                alert("å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
                console.error(e);
            } finally {
                btn.disabled = false;
                btn.textContent = "é€å‡ºè³‡æ–™";
            }
        }

        // 6. é¡¯ç¤ºä»Šæ—¥è©²ç­å·²è«‹å‡åå–® (Teacher View)
        let teacherUnsub;
        function loadClassRecords() {
            const date = document.getElementById('date').value;
            const classCode = classSelect.value;
            if(!classCode) return;

            document.getElementById('current-class-name').textContent = classSelect.options[classSelect.selectedIndex].text;
            const container = document.getElementById('teacher-records-container');

            if(teacherUnsub) teacherUnsub();

            teacherUnsub = db.collection("attendance")
                .where("date", "==", date)
                .where("classCode", "==", parseInt(classCode))
                .onSnapshot(snap => {
                    const list = [];
                    snap.forEach(d => list.push(d.data()));
                    list.sort((a,b) => a.seatNo - b.seatNo);
                    
                    if (list.length === 0) {
                        container.innerHTML = '<p style="color:#999; text-align:center;">ç›®å‰ç„¡äººè«‹å‡</p>';
                    } else {
                        container.innerHTML = '';
                        list.forEach(d => {
                            const div = document.createElement('div');
                            div.className = `record-item ${d.type}`;
                            div.innerHTML = `
                                <span><strong>${d.seatNo}è™Ÿ</strong> ${d.name}</span>
                                <span class="tag ${d.type}">${d.type}</span>
                            `;
                            container.appendChild(div);
                        });
                    }
                });
        }
        document.getElementById('date').addEventListener('change', loadClassRecords);

        // 7. å¾Œå°ç®¡ç†
        function toggleAdminView() {
            const el = document.getElementById('admin-section');
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
            if(el.style.display === 'block') el.scrollIntoView({behavior:'smooth'});
        }

        function checkLogin() {
            if(document.getElementById('admin-pwd').value === '1234') {
                document.getElementById('login-panel').style.display = 'none';
                document.getElementById('data-panel').style.display = 'block';
                startAdminListener();
            } else alert('å¯†ç¢¼éŒ¯èª¤');
        }

        function logout() {
            document.getElementById('login-panel').style.display = 'block';
            document.getElementById('data-panel').style.display = 'none';
            if(adminUnsub) adminUnsub();
        }

        // å¾Œå°ç›£è½
        let adminUnsub;
        function startAdminListener() {
            const date = document.getElementById('admin-date-filter').value;
            const container = document.getElementById('records-container');
            if(adminUnsub) adminUnsub();

            adminUnsub = db.collection("attendance").where("date", "==", date)
                .onSnapshot(snap => {
                    const list = [];
                    snap.forEach(d => list.push(d.data()));
                    // æ’åºï¼šç­ç´š -> åº§è™Ÿ
                    list.sort((a,b) => (a.classCode - b.classCode) || (a.seatNo - b.seatNo));
                    
                    container.innerHTML = list.length ? '' : '<p style="text-align:center;color:#999;padding:20px;">æœ¬æ—¥å°šç„¡è³‡æ–™</p>';
                    
                    let lastClass = null;
                    list.forEach(d => {
                        if (d.classCode !== lastClass) {
                            container.innerHTML += `<div style="background:#eee; padding:8px; margin:15px 0 5px; font-weight:bold; border-radius:4px;">${d.className}</div>`;
                            lastClass = d.classCode;
                        }
                        container.innerHTML += `
                            <div class="record-item ${d.type}">
                                <span>${d.seatNo}è™Ÿ ${d.name}</span>
                                <span class="tag ${d.type}">${d.type}</span>
                            </div>`;
                    });
                });
        }
        document.getElementById('admin-date-filter').addEventListener('change', startAdminListener);

        function showToast(msg) {
            const x = document.getElementById("toast");
            x.textContent = msg; x.className = "show";
            setTimeout(()=>{ x.className = x.className.replace("show", ""); }, 3000);
        }
    </script>
</body>
</html>
