<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§å‰åœ‹ä¸­ - å­¸ç”Ÿå‡ºç¼ºå¸­ç®¡ç†ç³»çµ±</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary-color: #2196F3;
            --bg-color: #f4f7f6;
            --text-color: #333;
        }

        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: var(--text-color);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        h1, h2, h3 { text-align: center; color: #2c3e50; }

        .form-group { margin-bottom: 20px; }

        label { display: block; margin-bottom: 8px; font-weight: bold; }

        input[type="date"], select, input[type="password"] {
            width: 100%; padding: 12px; border: 1px solid #ddd;
            border-radius: 6px; font-size: 16px; box-sizing: border-box;
            background-color: #fff;
        }

        button {
            width: 100%; padding: 15px; background-color: var(--primary-color);
            color: white; border: none; border-radius: 6px; font-size: 18px;
            cursor: pointer; transition: background 0.3s;
        }
        button:hover { background-color: #1976D2; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* å‡åˆ¥æŒ‰éˆ•è¨­è¨ˆ */
        .leave-options {
            display: grid; /* æ”¹ç”¨ Grid è®“ 4 å€‹æŒ‰éˆ•è‡ªå‹•æ’åˆ— */
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* è‡ªå‹•é©æ‡‰ */
            gap: 10px;
        }
        .leave-option {
            position: relative;
        }
        .leave-option input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
            z-index: 2;
        }
        .leave-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 50px; /* å›ºå®šé«˜åº¦ */
            text-align: center;
            background: #f0f0f0;
            border-radius: 6px;
            border: 2px solid transparent;
            font-weight: bold;
            color: #555;
            transition: all 0.2s;
            font-size: 15px;
            line-height: 1.2;
        }
        
        /* é¸ä¸­ç‹€æ…‹é¡è‰²å€åˆ† */
        input[value="ç—…å‡"]:checked + .leave-btn {
            background-color: #ffebee; border-color: #e74c3c; color: #e74c3c;
        }
        input[value="äº‹å‡"]:checked + .leave-btn {
            background-color: #fff3e0; border-color: #f39c12; color: #f39c12;
        }
        input[value="å…¶ä»–"]:checked + .leave-btn {
            background-color: #e3f2fd; border-color: #2196F3; color: #2196F3;
        }
        input[value="æ› èª²"]:checked + .leave-btn {
            background-color: #eceff1; border-color: #455a64; color: #455a64;
        }
        
        /* åˆ—è¡¨æ¨£å¼ */
        .record-list { margin-top: 10px; }
        .record-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; background: #fff; border-radius: 6px; margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 5px solid #ddd;
        }
        
        /* åˆ—è¡¨æ¨™ç±¤é¡è‰² */
        .record-item.ç—…å‡ { border-left-color: #e74c3c; }
        .record-item.äº‹å‡ { border-left-color: #f39c12; }
        .record-item.å…¶ä»– { border-left-color: #2196F3; }
        .record-item.æ› èª² { border-left-color: #455a64; background-color: #fcfcfc; }
        
        .tag { padding: 4px 8px; border-radius: 4px; font-size: 12px; color: white; margin-left: 5px;}
        .tag.ç—…å‡ { background-color: #e74c3c; }
        .tag.äº‹å‡ { background-color: #f39c12; }
        .tag.å…¶ä»– { background-color: #2196F3; }
        .tag.æ› èª² { background-color: #455a64; } /* æ·±ç°è— */

        /* Admin Action Buttons */
        .admin-actions button {
            width: auto; padding: 5px 10px; font-size: 12px;
            margin-left: 5px; border-radius: 4px;
        }
        .btn-edit { background-color: #FF9800; }
        .btn-delete { background-color: #F44336; }
        
        #admin-section { display: none; margin-top: 40px; border-top: 2px dashed #ccc; padding-top: 20px; }
        .admin-login-trigger { text-align: center; margin-top: 50px; font-size: 12px; color: #ccc; }
        
        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff;
            text-align: center; border-radius: 4px; padding: 16px; position: fixed;
            z-index: 999; left: 50%; bottom: 30px; transform: translateX(-50%);
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <div class="container">
        <h1>å¤§å‰åœ‹ä¸­<br><span style="font-size: 0.7em; color: #7f8c8d; font-weight: normal;">å­¸ç”Ÿå‡ºç¼ºå¸­å›å ±</span></h1>
        
        <div id="teacher-form">
            <div class="form-group">
                <label for="date">ğŸ“… æ—¥æœŸ</label>
                <input type="date" id="date">
            </div>

            <div class="form-group">
                <label for="class-select">ğŸ« ç­ç´š</label>
                <select id="class-select" onchange="onClassChange()">
                    <option value="" disabled selected>è«‹é¸æ“‡ç­ç´š</option>
                    </select>
            </div>

            <div class="form-group">
                <label for="student-select">ğŸ‘¤ å­¸ç”Ÿå§“å</label>
                <select id="student-select">
                    <option value="" disabled selected>è«‹å…ˆé¸æ“‡ç­ç´š</option>
                </select>
            </div>

            <div class="form-group">
                <label>ğŸ“ å‡åˆ¥</label>
                <div class="leave-options">
                    <div class="leave-option">
                        <input type="radio" name="leaveType" value="ç—…å‡" id="type-sick" checked>
                        <label class="leave-btn" for="type-sick">ç—…å‡</label>
                    </div>
                    <div class="leave-option">
                        <input type="radio" name="leaveType" value="äº‹å‡" id="type-personal">
                        <label class="leave-btn" for="type-personal">äº‹å‡</label>
                    </div>
                    <div class="leave-option">
                        <input type="radio" name="leaveType" value="å…¶ä»–" id="type-other">
                        <label class="leave-btn" for="type-other">å…¶ä»–</label>
                    </div>
                    <div class="leave-option">
                        <input type="radio" name="leaveType" value="æ› èª²" id="type-absent">
                        <label class="leave-btn" for="type-absent">æ› èª²<br><span style="font-size:0.8em; font-weight:normal;">(é€£çµ¡ä¸ä¸Š)</span></label>
                    </div>
                </div>
            </div>

            <button onclick="submitData()">æ–°å¢ä¸€ç­†è³‡æ–™</button>

            <div class="form-group" style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                <h3 style="font-size: 1.1em; text-align: left; margin-bottom: 10px;">ğŸ“‹ ä»Šæ—¥å·²ç™»éŒ„åå–® <span id="current-class-display" style="font-size:0.8em; color:#666;"></span></h3>
                <div id="teacher-records-container" class="record-list">
                    <p style="color: #999; font-size: 0.9em;">(å°šæœªæœ‰è³‡æ–™)</p>
                </div>
            </div>
        </div>

        <div id="admin-section">
            <h2>å¾Œå°ç®¡ç†ç³»çµ±</h2>
            
            <div id="login-panel">
                <div class="form-group">
                    <label>å¯†ç¢¼</label>
                    <input type="password" id="admin-pwd" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
                </div>
                <button onclick="checkLogin()" style="background-color: #607d8b;">ç™»å…¥</button>
            </div>

            <div id="data-panel" style="display: none;">
                <div style="text-align: right; margin-bottom: 15px;">
                    <button onclick="logout()" style="width: auto; padding: 6px 15px; background-color: #95a5a6;">ç™»å‡º</button>
                </div>

                <div class="form-group">
                    <label>ğŸ” ç¯©é¸æ—¥æœŸ</label>
                    <input type="date" id="admin-date-filter">
                </div>
                <div id="records-container" class="record-list"></div>
            </div>
        </div>
    </div>

    <div class="admin-login-trigger"><a onclick="toggleAdminView()">Admin Login</a></div>
    <div id="toast"></div>

    <script>
        // 1. Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAeD-SR6_4uhGB1JH5PChkTPqyyNlNZpFY",
            authDomain: "leave-c84f8.firebaseapp.com",
            projectId: "leave-c84f8",
            storageBucket: "leave-c84f8.firebasestorage.app",
            messagingSenderId: "875704438036",
            appId: "1:875704438036:web:e4ff18be5dd41f80828601",
            measurementId: "G-DJ4538SQP8"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // 2. Class Data (Updated)
        const classData = {"101": [{"no": 1, "name": "æ–¹ç¥¥å®‡"}, {"no": 2, "name": "å³æ˜•ç¥"}, {"no": 3, "name": "æ—ç¥æ°‘"}, {"no": 4, "name": "é™³æ‰¿è²¿"}, {"no": 5, "name": "é™³å† å®"}, {"no": 6, "name": "é»ƒå­ç«¶"}, {"no": 7, "name": "æ¥Šæ°è«º"}, {"no": 8, "name": "è”¡é–”ç¡¯"}, {"no": 9, "name": "è•­å‰å‡±"}, {"no": 10, "name": "è¬æ˜ç¿°"}, {"no": 11, "name": "ç°¡è¾°æ©"}, {"no": 12, "name": "ç¾…å† å¯Œ"}, {"no": 13, "name": "ç‹å¾‹æ¶µ"}, {"no": 14, "name": "ä½•èŠ·æ©"}, {"no": 15, "name": "æä¾‘æ¬£"}, {"no": 16, "name": "ææ—»æ½”"}, {"no": 17, "name": "æèŠ®ç‘€"}, {"no": 18, "name": "æ—ä½‘çˆ"}, {"no": 19, "name": "æ—èŠŠå¦¤"}, {"no": 20, "name": "æ´ªç®æ…ˆ"}, {"no": 21, "name": "è¨±èªç³"}, {"no": 22, "name": "æ¸¸è‹¥è•“"}, {"no": 23, "name": "é»ƒæ€¡ç‘„"}, {"no": 24, "name": "é»ƒèªæŸ”"}, {"no": 25, "name": "å¾æ³³æ¸…"}], "102": [{"no": 1, "name": "ç‹ç·¯é¨°"}, {"no": 2, "name": "å³æ¥¨é€¸"}, {"no": 3, "name": "å³æ¥¨ç¿”"}, {"no": 4, "name": "æåœ‹ç¥¥"}, {"no": 5, "name": "ææ™¨é™½"}, {"no": 6, "name": "æ—æ°¸é †"}, {"no": 7, "name": "æ´ªèŒ‚ç‘‹"}, {"no": 8, "name": "æ´ªæ™¨éˆ"}, {"no": 9, "name": "å¼µæ³³ç´³"}, {"no": 10, "name": "åŠ‰å®¥å‘ˆ"}, {"no": 11, "name": "è•­æ–‡å‚‘"}, {"no": 12, "name": "è³´æ˜±ç¶­"}, {"no": 13, "name": "è³´æ•¬å‹›"}, {"no": 14, "name": "å³å­ç‘œ"}, {"no": 15, "name": "ææ¬£è“‰"}, {"no": 16, "name": "é˜®å¦®è"}, {"no": 17, "name": "æ—ç‘¾è–°"}, {"no": 18, "name": "å¼µèªæ¬"}, {"no": 19, "name": "éƒ­æ•èŠ³"}, {"no": 20, "name": "æ›¾å©·éŒ¡"}, {"no": 21, "name": "é»ƒå®›æ¦†"}, {"no": 22, "name": "é»ƒå©•æ©"}, {"no": 23, "name": "é„­å¤©æ…§"}, {"no": 24, "name": "è•­é›…é¦¨"}, {"no": 25, "name": "é™³å† è±ª"}, {"no": 26, "name": "æ¥Šèˆ’è¬ "}], "103": [{"no": 1, "name": "ç‹ä¿Šé›„"}, {"no": 2, "name": "æå»ºå»·"}, {"no": 3, "name": "æ—ç¥å®‰"}, {"no": 4, "name": "æ—è”šæ¾„"}, {"no": 5, "name": "é‚±å³»å®"}, {"no": 6, "name": "é¦¬è©³é–”"}, {"no": 7, "name": "èŠé‘«è–"}, {"no": 8, "name": "è¨±å‹æº¢"}, {"no": 9, "name": "é™³å‹‡ç”·"}, {"no": 10, "name": "æ›¾æ³“ç¿"}, {"no": 11, "name": "é»ƒç¨æ£‹"}, {"no": 12, "name": "åŠ‰æ‰¿å‹³"}, {"no": 13, "name": "è”¡ç«ºæ©"}, {"no": 14, "name": "ä½•èªå–¬"}, {"no": 15, "name": "å‘‚å®‡ç¦"}, {"no": 16, "name": "æ—éƒé›¯"}, {"no": 17, "name": "å¼µæ²›ç¿"}, {"no": 18, "name": "é»ƒå“ç’‡"}, {"no": 19, "name": "é»ƒæ¹˜æ™´"}, {"no": 20, "name": "æ¥Šä½³ç¿"}, {"no": 21, "name": "åŠ‰æ²…èŠ¯"}, {"no": 22, "name": "è”¡æ˜€è‡»"}, {"no": 23, "name": "è•­ç¿Šæ¶µ"}, {"no": 24, "name": "è¬æƒ å¦‚"}, {"no": 25, "name": "é¡å­è–°"}, {"no": 26, "name": "é‚±è­¯è³¢"}], "104": [{"no": 1, "name": "ç‹è‡´å‡±"}, {"no": 2, "name": "æ±Ÿå³ç’¿"}, {"no": 3, "name": "å³æ–‡å„„"}, {"no": 4, "name": "å³äº¦æ·"}, {"no": 5, "name": "å³ç¿°æ˜‡"}, {"no": 6, "name": "ææ”¿æ©"}, {"no": 7, "name": "é‚±é€¸ä¿®"}, {"no": 8, "name": "æŸ¯ç§‰ä½‘"}, {"no": 9, "name": "éƒ­å®—å¼¦"}, {"no": 10, "name": "é»ƒä»²ä½‘"}, {"no": 11, "name": "é»ƒç…§å‚‘"}, {"no": 12, "name": "é„­èŠ³èŒ‚"}, {"no": 13, "name": "ç‹éŸ»ç”¯"}, {"no": 14, "name": "ä½•å©•æ™¨"}, {"no": 15, "name": "ææ²›ç·¹"}, {"no": 16, "name": "æå®¶ç‘œ"}, {"no": 17, "name": "é˜®è²è¢"}, {"no": 18, "name": "å¼µæ²›æ™´"}, {"no": 19, "name": "å¼µèˆ’å©·"}, {"no": 20, "name": "é™³å®¥è«ª"}, {"no": 21, "name": "é™³æ˜±ç’‡"}, {"no": 22, "name": "é»„é–”å²"}, {"no": 23, "name": "æ›¾æ€¡è–°"}, {"no": 24, "name": "æ¥Šå–¬éˆ"}, {"no": 25, "name": "å¾éœˆç’‡"}], "105": [{"no": 1, "name": "æ—å¤è«º"}, {"no": 2, "name": "å¼µåˆæ™Ÿ"}, {"no": 3, "name": "é™³æ¢“ç¿"}, {"no": 4, "name": "é™³éˆºç¿”"}, {"no": 5, "name": "é»„å­èª "}, {"no": 6, "name": "æ¥Šç«‹å®‰"}, {"no": 7, "name": "é„­ç…œè"}, {"no": 8, "name": "é„­ç…œå¶§"}, {"no": 9, "name": "ç›§ç´³ç¿°"}, {"no": 10, "name": "ç‹äºç²"}, {"no": 11, "name": "ç‹å©•ç‘œ"}, {"no": 12, "name": "æ–½æ¬£ç‘œ"}, {"no": 13, "name": "èŠå­æ¬£"}, {"no": 14, "name": "é™³æ²›æ¶µ"}, {"no": 15, "name": "é™³ä½©çœŸ"}, {"no": 16, "name": "é™³çˆå¦¤"}, {"no": 17, "name": "æ¸¸ç´«æ™´"}, {"no": 18, "name": "æ¥Šæ‡¿çª"}, {"no": 19, "name": "è”¡ä½³è“"}, {"no": 20, "name": "ç°¡æ©å¤š"}, {"no": 21, "name": "è—æ‚»æ¡"}], "201": [{"no": 1, "name": "ç‹é€²å¾·"}, {"no": 2, "name": "æ±Ÿç§‰ç´˜"}, {"no": 3, "name": "ä½•æ›¸æ±"}, {"no": 4, "name": "å³å»ºæ˜±"}, {"no": 5, "name": "æå®‡ç¿”"}, {"no": 6, "name": "ææ±å“²"}, {"no": 7, "name": "æ—æ­£èš"}, {"no": 8, "name": "æ—å®å‹³"}, {"no": 9, "name": "æ—æš„ç¥"}, {"no": 10, "name": "å­«æµ©ç¥¥"}, {"no": 11, "name": "æ¶‚ç¿æ°"}, {"no": 12, "name": "é™³æ¥·å¡"}, {"no": 13, "name": "æ¥Šæ³“é‡"}, {"no": 14, "name": "æ¥Šç§‰éˆ"}, {"no": 15, "name": "é„­åšå‡"}, {"no": 16, "name": "è•­é †é¨°"}, {"no": 17, "name": "ç°¡äºå‡±"}, {"no": 18, "name": "ç¾…æšçµ"}, {"no": 19, "name": "ä½•æµ¿ç¾½"}, {"no": 20, "name": "æ—ç™¸å¦™"}, {"no": 21, "name": "æ—ç¦¹é¦¨"}, {"no": 22, "name": "é‚±æ–¹éƒ"}, {"no": 23, "name": "æŸ¯æ¬£èŠ¸"}, {"no": 24, "name": "éƒ­èŠ¯å¦¤"}, {"no": 25, "name": "é™³å½¥ç«¹"}], "202": [{"no": 2, "name": "ç‹éˆæ¾¤"}, {"no": 4, "name": "æå‡­æ½¤"}, {"no": 5, "name": "ææ‰¿ç¿°"}, {"no": 6, "name": "å¾ç¥¥ç¿"}, {"no": 8, "name": "å¼µç´˜ç¹"}, {"no": 9, "name": "èŠå‡±å‚‘"}, {"no": 10, "name": "è¨±å…æ‡·"}, {"no": 11, "name": "é™³å…‰ç‚³"}, {"no": 12, "name": "é»ƒç§‰è±"}, {"no": 13, "name": "åŠ‰å…‰çˆ"}, {"no": 14, "name": "åŠ‰äº®å‘ˆ"}, {"no": 15, "name": "åŠ‰æ™éŠ˜"}, {"no": 16, "name": "è”¡æ˜€å¡"}, {"no": 17, "name": "è³´æ”¿è£•"}, {"no": 18, "name": "è˜‡è€•ç„"}, {"no": 19, "name": "å³ç«ºå®¹"}, {"no": 20, "name": "æ´ªé‘€å¨£"}, {"no": 21, "name": "æ¶‚ç¾½å²‘"}, {"no": 22, "name": "é™³æ€¡å‡"}, {"no": 23, "name": "é™³ç¾¿ç¶¾"}, {"no": 24, "name": "é™¸å®£ç¾½"}, {"no": 25, "name": "æ¸¸ç·—ç¿"}, {"no": 26, "name": "å¼µæ—¨å›"}, {"no": 27, "name": "ä½™ä¿Šå¸Œ"}], "203": [{"no": 1, "name": "æ±Ÿç§‰ç¿Š"}, {"no": 2, "name": "å³ç§‰æ©™"}, {"no": 3, "name": "ææ³Šç‘¾"}, {"no": 4, "name": "å²³åˆæ‰¿"}, {"no": 5, "name": "æ—å®¸å…‰"}, {"no": 6, "name": "é«˜å˜‰éš†"}, {"no": 7, "name": "å¼µæ±è€€"}, {"no": 8, "name": "å¼µåº­é­"}, {"no": 9, "name": "è¨±å‡±æ˜•"}, {"no": 10, "name": "é™³å½¥å»·"}, {"no": 11, "name": "é™³è‡´èª "}, {"no": 12, "name": "é»ƒè‡´å’Œ"}, {"no": 13, "name": "é»ƒæ¾„å®‡"}, {"no": 14, "name": "åŠ‰æ˜±ç‘‹"}, {"no": 15, "name": "é„­å³»æ±"}, {"no": 16, "name": "è•­ä½³å§”"}, {"no": 17, "name": "ç°¡çš‡æ©"}, {"no": 18, "name": "è˜‡ç¨šå‡±"}, {"no": 19, "name": "æ—æ²›æº±"}, {"no": 20, "name": "å­«æ•é½¡"}, {"no": 22, "name": "é™³å¥•ç¯‰"}, {"no": 23, "name": "ç¾…å¹¸è“"}, {"no": 24, "name": "å§œå­æ¶µ"}], "204": [{"no": 1, "name": "ä½•ç¿ä¿¡"}, {"no": 2, "name": "é™³æŸç¿°"}, {"no": 3, "name": "é»ƒæ˜ç’¿"}, {"no": 4, "name": "é»ƒå‰‡å–„"}, {"no": 5, "name": "é»ƒæšç¿°"}, {"no": 6, "name": "åŠ‰æ ¢ç¿"}, {"no": 7, "name": "æ—èŠŠæƒ "}, {"no": 8, "name": "æ®µå­Ÿæ¶µ"}, {"no": 9, "name": "æ´ªç…œæ™´"}, {"no": 10, "name": "å¼µè‚²æ…ˆ"}, {"no": 11, "name": "è¨±ä»¤éœ"}, {"no": 12, "name": "å»–ä»¥æ™¨"}, {"no": 13, "name": "åŠ‰æ™å¦¤"}], "301": [{"no": 1, "name": "ä½•è‚²é¨°"}, {"no": 2, "name": "ä½•ç§‰ç¥"}, {"no": 3, "name": "æå½¥è«„"}, {"no": 4, "name": "è¨±ç«‹å“²"}, {"no": 5, "name": "é™³å† æ–‡"}, {"no": 6, "name": "æ¹¯å®ˆæ­£"}, {"no": 7, "name": "æ¥Šç™»ç¨‹"}, {"no": 8, "name": "è‘‰å† é™"}, {"no": 9, "name": "åŠ‰éŸ‹è‘£"}, {"no": 10, "name": "ç›§å»ºäº¨"}, {"no": 11, "name": "è˜‡ç…¥å…ƒ"}, {"no": 12, "name": "çŸ³å®¶è“"}, {"no": 13, "name": "å³ç¥å¦¤"}, {"no": 14, "name": "å³å§µè±"}, {"no": 15, "name": "æç‰é³³"}, {"no": 16, "name": "æäºèŠ¸"}, {"no": 17, "name": "æç¾ç§€"}, {"no": 18, "name": "ç›§éœå²‘"}, {"no": 19, "name": "è³´å·§åµ"}, {"no": 20, "name": "ç¾…çªæ·‹"}], "302": [{"no": 1, "name": "æ–¹æŸæ·µ"}, {"no": 3, "name": "æ–½å‡è«º"}, {"no": 4, "name": "å¼µç¥å®‡"}, {"no": 6, "name": "è¨±è© å½¬"}, {"no": 7, "name": "é™³å¨æ„·"}, {"no": 8, "name": "é»ƒå®ç« "}, {"no": 9, "name": "é»ƒç¿”"}, {"no": 10, "name": "åŠ‰ä¸€å®‰"}, {"no": 11, "name": "è³´è¾°æ˜±"}, {"no": 12, "name": "æ–¹å–»æ™´"}, {"no": 13, "name": "ææ€äº­"}, {"no": 14, "name": "æç¾æ©"}, {"no": 15, "name": "é‚±çŸç¶º"}, {"no": 16, "name": "é™³èªæ™¨"}, {"no": 17, "name": "å»–ä»¥æ™´"}, {"no": 18, "name": "åŠ‰é›¨æŸ”"}, {"no": 19, "name": "é¡ç‘œç­ "}, {"no": 20, "name": "é¾”å®¶è±"}, {"no": 21, "name": "è‘‰æ©è“‰"}, {"no": 23, "name": "å‘¨å­ç”„"}], "303": [{"no": 1, "name": "ä½•è‚²é§¿"}, {"no": 2, "name": "ä½•æ¾æ¾¤"}, {"no": 3, "name": "å³æ‰¿å¡"}, {"no": 4, "name": "å³é€²å’Œ"}, {"no": 5, "name": "åŠ‰äºå¶§"}, {"no": 6, "name": "è”¡å®—å¡"}, {"no": 7, "name": "è”¡çç··"}, {"no": 8, "name": "è”¡æŸæ˜±"}, {"no": 9, "name": "é¾å¯Œç¨‹"}, {"no": 10, "name": "é¡å´‡å‡±"}, {"no": 12, "name": "æç‰çª"}, {"no": 13, "name": "æœä»»å©•"}, {"no": 14, "name": "æ—å¦è±«"}, {"no": 15, "name": "é™³éŸ‹æ±"}, {"no": 16, "name": "å»–æ„è²"}, {"no": 17, "name": "è”¡ç‘œå«™"}, {"no": 18, "name": "é„­æ¹˜è“‰"}, {"no": 19, "name": "ç°¡è‹¡å®‰"}, {"no": 21, "name": "æ±Ÿç§‰è»’"}], "304": [{"no": 1, "name": "æ¸¸æ™ºç¿”"}, {"no": 2, "name": "é„­ç§‰æ©"}, {"no": 3, "name": "æå®—è«º"}, {"no": 4, "name": "æ—ç¥ä»»"}, {"no": 5, "name": "ç¿ç¬ ç´˜"}, {"no": 6, "name": "é™³ä¾‘å¨"}, {"no": 7, "name": "é™³å† ç¶¸"}, {"no": 9, "name": "æˆ´è¿å‘ˆ"}, {"no": 10, "name": "è˜‡ç«‹å…ƒ"}, {"no": 11, "name": "è˜‡è–åš"}, {"no": 12, "name": "ä½•ä¸ç‘œ"}, {"no": 13, "name": "å³å¦è±"}, {"no": 14, "name": "å³æ›¼ç”„"}, {"no": 15, "name": "æ—éŸ‹è‡»"}, {"no": 16, "name": "æŸ¯æ·è‹’"}, {"no": 17, "name": "å¼µè»’æ…ˆ"}, {"no": 19, "name": "é™³æ€¡ç‘„"}, {"no": 20, "name": "æ›¾è‹¡ç‘„"}, {"no": 21, "name": "è”¡å§¿å¬ª"}, {"no": 22, "name": "æ¥Šç´«ç’¿"}], "305": [{"no": 1, "name": "å³å­å‹»"}, {"no": 2, "name": "ç¿æ¢“å®¸"}, {"no": 3, "name": "è¨±åšéˆ"}, {"no": 4, "name": "é™³æ–‡æ›¸"}, {"no": 5, "name": "åŠ‰ä¿Šå¾·"}, {"no": 6, "name": "åŠ‰å®¸å‡"}, {"no": 7, "name": "ç¾…ç¥¥ç¿"}, {"no": 8, "name": "ä½•äº®éš"}, {"no": 9, "name": "ä½•ç¦¹æŸ”"}, {"no": 10, "name": "æ—çœŸä¼ƒ"}, {"no": 11, "name": "æ´ªåƒé›…"}, {"no": 13, "name": "æ´ªæ–°æƒ "}, {"no": 14, "name": "å¼µæ›¸ç‘"}, {"no": 15, "name": "é™³è©©æ¶µ"}, {"no": 16, "name": "é»ƒå®‡æ…ˆ"}, {"no": 17, "name": "é»ƒå“è“‰"}, {"no": 18, "name": "é»ƒå®£æ™´"}, {"no": 19, "name": "é»ƒç¿Šé›¯"}, {"no": 20, "name": "æ¥ŠèŠ¸æ¦›"}, {"no": 21, "name": "æ¥Šæ‡¿ç­‘"}, {"no": 22, "name": "è•­å©‰å¦¤"}, {"no": 23, "name": "è¬å£¹å§"}]};

        // 3. Init
        const classSelect = document.getElementById('class-select');
        const studentSelect = document.getElementById('student-select');
        const todayStr = new Date().toISOString().split('T')[0];
        
        document.getElementById('date').value = todayStr;
        document.getElementById('admin-date-filter').value = todayStr;

        function initClassDropdown() {
            classSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡ç­ç´š</option>';
            const ranges = { 1: 5, 2: 4, 3: 5 };
            for (let g = 1; g <= 3; g++) {
                for (let c = 1; c <= ranges[g]; c++) {
                    const val = `${g}${c.toString().padStart(2, '0')}`;
                    const name = `${g}å¹´${c}ç­`;
                    const opt = document.createElement('option');
                    opt.value = val;
                    opt.textContent = name;
                    classSelect.appendChild(opt);
                }
            }
        }
        initClassDropdown();

        function onClassChange() {
            const classCode = classSelect.value;
            if (!classCode) return;
            studentSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡å­¸ç”Ÿ</option>';
            const students = classData[classCode];
            if (students) {
                students.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.no;
                    opt.textContent = `${s.no}è™Ÿ ${s.name}`;
                    opt.setAttribute('data-name', s.name);
                    studentSelect.appendChild(opt);
                });
            }
            loadTeacherRecords();
        }

        // 4. Submit
        async function submitData() {
            const date = document.getElementById('date').value;
            const classCode = classSelect.value;
            const className = classSelect.options[classSelect.selectedIndex]?.text;
            const seatNoVal = studentSelect.value;
            
            if (!date || !classCode || !seatNoVal) {
                alert("è«‹å®Œæ•´å¡«å¯«æ—¥æœŸã€ç­ç´šèˆ‡å­¸ç”Ÿ");
                return;
            }

            const selectedOpt = studentSelect.options[studentSelect.selectedIndex];
            const name = selectedOpt.getAttribute('data-name');
            const type = document.querySelector('input[name="leaveType"]:checked').value;
            
            const btn = document.querySelector('button[onclick="submitData()"]');
            btn.disabled = true;
            btn.textContent = "å„²å­˜ä¸­...";

            try {
                // Check if user is trying to overwrite (optional, but here we just add)
                await db.collection("attendance").add({
                    date: date,
                    classCode: parseInt(classCode),
                    className: className,
                    seatNo: parseInt(seatNoVal),
                    name: name,
                    type: type,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast(`æˆåŠŸæ–°å¢ï¼š${seatNoVal}è™Ÿ ${name} (${type})`);
                studentSelect.value = ""; // Reset student
                
            } catch (e) {
                alert("å„²å­˜å¤±æ•—");
                console.error(e);
            } finally {
                btn.disabled = false;
                btn.textContent = "æ–°å¢ä¸€ç­†è³‡æ–™";
            }
        }

        // 5. Teacher View
        let teacherUnsub;
        function loadTeacherRecords() {
            const date = document.getElementById('date').value;
            const classCode = classSelect.value;
            if(!classCode) return;

            document.getElementById('current-class-display').textContent = `(${classSelect.options[classSelect.selectedIndex].text})`;
            const container = document.getElementById('teacher-records-container');

            if(teacherUnsub) teacherUnsub();

            teacherUnsub = db.collection("attendance")
                .where("date", "==", date)
                .where("classCode", "==", parseInt(classCode))
                .orderBy("timestamp", "desc")
                .onSnapshot(snap => {
                    const list = [];
                    snap.forEach(d => list.push(d.data()));
                    container.innerHTML = list.length ? '' : '<p style="color:#999; text-align:center;">ç›®å‰ç„¡è³‡æ–™</p>';
                    list.forEach(d => {
                        // Display logic for "æ—·è¯¾" special label in list if needed, or just type
                        // We store "æ› èª²", CSS handles the styling.
                        let typeDisplay = d.type;
                        if(typeDisplay === "æ› èª²") typeDisplay = "æ› èª² (é€£çµ¡ä¸ä¸Š)";

                        const div = document.createElement('div');
                        div.className = `record-item ${d.type}`;
                        div.innerHTML = `
                            <span><strong>${d.seatNo}è™Ÿ</strong> ${d.name}</span>
                            <span class="tag ${d.type}">${typeDisplay}</span>
                        `;
                        container.appendChild(div);
                    });
                });
        }
        document.getElementById('date').addEventListener('change', loadTeacherRecords);

        // 6. Admin
        function toggleAdminView() {
            const el = document.getElementById('admin-section');
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
            if(el.style.display === 'block') el.scrollIntoView({behavior:'smooth'});
        }

        function checkLogin() {
            if(document.getElementById('admin-pwd').value === '1234') {
                document.getElementById('login-panel').style.display = 'none';
                document.getElementById('data-panel').style.display = 'block';
                startAdminListener();
            } else alert('å¯†ç¢¼éŒ¯èª¤');
        }

        function logout() {
            document.getElementById('login-panel').style.display = 'block';
            document.getElementById('data-panel').style.display = 'none';
            if(adminUnsub) adminUnsub();
        }

        let adminUnsub;
        function startAdminListener() {
            const date = document.getElementById('admin-date-filter').value;
            const container = document.getElementById('records-container');
            if(adminUnsub) adminUnsub();

            adminUnsub = db.collection("attendance").where("date", "==", date)
                .onSnapshot(snap => {
                    const list = [];
                    snap.forEach(doc => list.push({ id: doc.id, ...doc.data() }));
                    list.sort((a,b) => (a.classCode - b.classCode) || (a.seatNo - b.seatNo));
                    
                    container.innerHTML = list.length ? '' : '<p style="text-align:center;color:#999;padding:20px;">æœ¬æ—¥å°šç„¡è³‡æ–™</p>';
                    let lastClass = null;
                    list.forEach(d => {
                        if (d.classCode !== lastClass) {
                            container.innerHTML += `<div style="background:#eee; padding:8px; margin:15px 0 5px; font-weight:bold; border-radius:4px;">${d.className}</div>`;
                            lastClass = d.classCode;
                        }
                        
                        let typeDisplay = d.type;
                        if(typeDisplay === "æ› èª²") typeDisplay = "æ› èª² (é€£çµ¡ä¸ä¸Š)";

                        const div = document.createElement('div');
                        div.className = `record-item ${d.type}`;
                        div.innerHTML = `
                            <div>
                                <span>${d.seatNo}è™Ÿ ${d.name}</span>
                                <span class="tag ${d.type}">${typeDisplay}</span>
                            </div>
                            <div class="admin-actions">
                                <button class="btn-edit" onclick="editRecord('${d.id}', '${d.name}', '${d.type}')">ä¿®æ”¹</button>
                                <button class="btn-delete" onclick="deleteRecord('${d.id}', '${d.name}')">åˆªé™¤</button>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                });
        }
        document.getElementById('admin-date-filter').addEventListener('change', startAdminListener);

        function deleteRecord(id, name) {
            if(confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€çš„ç´€éŒ„å—ï¼Ÿ`)) {
                db.collection("attendance").doc(id).delete()
                    .then(() => showToast("å·²åˆªé™¤"))
                    .catch(e => alert("åˆªé™¤å¤±æ•—"));
            }
        }

        function editRecord(id, name, currentType) {
            const newType = prompt(`è«‹è¼¸å…¥ã€Œ${name}ã€çš„æ–°å‡åˆ¥ (ç—…å‡/äº‹å‡/å…¶ä»–/æ› èª²)ï¼š`, currentType);
            const validTypes = ['ç—…å‡','äº‹å‡','å…¶ä»–','æ› èª²'];
            if(newType && validTypes.includes(newType)) {
                db.collection("attendance").doc(id).update({ type: newType })
                    .then(() => showToast("ä¿®æ”¹æˆåŠŸ"))
                    .catch(e => alert("ä¿®æ”¹å¤±æ•—"));
            } else if (newType) {
                alert("è«‹è¼¸å…¥æ­£ç¢ºçš„å‡åˆ¥ï¼šç—…å‡, äº‹å‡, å…¶ä»–, æ› èª²");
            }
        }

        function showToast(msg) {
            const x = document.getElementById("toast");
            x.textContent = msg; x.className = "show";
            setTimeout(()=>{ x.className = x.className.replace("show", ""); }, 3000);
        }
    </script>
</body>
</html>
